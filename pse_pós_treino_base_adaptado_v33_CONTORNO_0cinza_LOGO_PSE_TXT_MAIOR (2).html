<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PSE P√≥s‚ÄëTreino</title>
  <style>
    :root{
      --bg:#0f1115;--muted:#9aa2b1;--text:#e8ecf1;--accent:#4f8cff;
      --fieldGrad:linear-gradient(180deg,#2a0f0f,#140707);
      --gkGrad:linear-gradient(180deg,#0e1730,#081025);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1200px 1200px at 80% -10%, #182033 0%, var(--bg) 60%);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-tap-highlight-color:transparent;
    }
    header{
      position:sticky;top:0;z-index:60;
      background:linear-gradient(180deg,rgba(10,12,18,.95),rgba(10,12,18,.7) 60%,rgba(10,12,18,0));
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:8px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .title{display:flex;align-items:center;gap:10px;font-weight:950;font-size:14px}
    .title small{color:var(--muted);font-weight:900}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{
      background:#1a1f2e;border:1px solid rgba(255,255,255,.08);
      border-radius:10px;padding:6px 10px;font-weight:900;cursor:pointer;font-size:13px;
      user-select:none;
    }
    .tab.active{background:#2a3250;border-color:#3b4d93}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    button{
      appearance:none;border:0;border-radius:10px;padding:6px 10px;background:#212537;color:var(--text);
      font-weight:900;box-shadow:0 0 0 1px rgba(255,255,255,.06);cursor:pointer;font-size:13px;
    }
    button:active{transform:scale(.98)}
    .accent{background:linear-gradient(180deg,#2a4ea8,#1b2f74);box-shadow:0 0 0 1px #2c4fb9,0 0 0 6px rgba(79,140,255,.20)}
    .danger{background:linear-gradient(180deg,#893131,#5a1d1d)}
    .ghost{background:#1a1d2b}
    .layout{display:grid;gap:10px;padding:10px;padding-bottom:90px;max-width:1400px;margin:0 auto;}
    .layout.full{grid-template-columns:1fr}
    .rowTitle{font-weight:950;color:var(--muted);margin:2px 0 2px 4px;font-size:11px}

    .grid{display:grid;gap:6px}
    .grid.profiles{grid-template-columns:repeat(auto-fill,minmax(208px,1fr))}
    .card{
      border-radius:12px;padding:8px;
      box-shadow:0 0 0 1px rgba(255,255,255,.06),0 6px 18px rgba(0,0,0,.3);
      display:flex;flex-direction:column;gap:8px;width:100%;
      overflow:hidden;background:linear-gradient(180deg,#171b28,#10131c);
    }
    .card.field{background:var(--fieldGrad);box-shadow:0 0 0 2px rgba(255,90,90,.35),0 6px 18px rgba(0,0,0,.3)}
    .card.gk{background:var(--gkGrad);box-shadow:0 0 0 2px rgba(47,114,255,.5),0 6px 18px rgba(0,0,0,.3)}
    .avatarRow{display:flex;align-items:center;gap:8px}
    .avatar{
      width:38px;height:38px;border-radius:50%;
      background:#2a3250;color:#dfe6ff;
      display:flex;align-items:center;justify-content:center;font-weight:950;
      box-shadow:0 0 0 1px rgba(255,255,255,.08);
      background-size:cover;background-position:center;
      flex:0 0 auto;
    }
    .avatar.lg{width:52px;height:52px}
    .nameLine{display:flex;align-items:center;gap:8px}
    .numInput{
      width:54px;text-align:center;
      padding:6px 8px;background:#0f1320;color:var(--text);
      border:1px solid rgba(255,255,255,.10);border-radius:8px;font-weight:950;font-size:13px;
    }
    .nameInput{
      flex:1;padding:6px 8px;background:#0f1320;color:var(--text);
      border:1px solid rgba(255,255,255,.10);border-radius:8px;font-weight:950;font-size:13px;min-width:120px;
    }
    .roleSel{
      background:#0f1320;color:var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius:8px;padding:6px 8px;font-weight:950;font-size:12px
    }
    .note{font-size:12px;color:var(--muted);font-weight:900}

    /* In√≠cio */
    .choiceGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media (max-width:720px){ .choiceGrid{grid-template-columns:1fr} }
    .choiceCard{
      border-radius:14px;padding:18px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,#171b28,#0f1320);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      cursor:pointer;user-select:none;
      display:flex;align-items:center;justify-content:center;
      min-height:120px;
    }
    .choiceCard:active{transform:scale(.995)}
    .choiceTitle{font-weight:950;font-size:28px;letter-spacing:1px;text-align:center}

    .dtRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .dtBtn{
      width:100%;padding:16px 12px;border-radius:14px;
      font-size:18px;font-weight:950;border:1px solid rgba(255,255,255,.10);background:#0f1320;
    }
    .resetSmall{width:100%;padding:10px 12px;border-radius:12px;font-size:14px;font-weight:950}

    /* PSE */
    .pseWrap{
      background:linear-gradient(180deg,#171b28,#0f1320);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .pseTop{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .pseWho{display:flex;align-items:center;gap:10px;min-width:0}
    .pseWho .whoTxt{display:flex;flex-direction:column;min-width:0}
    .pseWho .whoName{font-weight:950;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
    .pseWho .whoMeta{font-size:12px;color:var(--muted);font-weight:900}
    .pseButtons{display:grid;grid-template-columns:repeat(10,minmax(0,1fr));gap:8px;}
    @media (max-width:980px){ .pseButtons{grid-template-columns:repeat(5,minmax(0,1fr))} }
    @media (max-width:520px){ .pseButtons{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .pseBtn{
      background:#0f1320;border:2px solid rgba(255,255,255,.10);
      border-radius:10px;padding:12px 0;font-weight:950;font-size:16px;cursor:pointer;user-select:none;text-align:center;
      transition:transform .06s ease, background .12s ease, border-color .12s ease;min-height:52px;
    }
    .pseBtn:active{transform:scale(.98)}
    .pseBtn.selected{border-color:rgba(79,140,255,.85);background:rgba(79,140,255,.18);box-shadow:0 0 0 4px rgba(79,140,255,.10)}
    .confirmRow{margin-top:10px;display:flex;align-items:center;justify-content:flex-end;gap:8px;flex-wrap:wrap;}
    .confirmHint{margin-right:auto;color:var(--muted);font-size:12px;font-weight:900}

    /* Overlay picker */
    .overlayPicker{position:fixed;inset:0;z-index:1000;background:rgba(8,10,16,.6);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;padding:14px}
    .overlayPanel{background:#0e1320;border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 22px 80px rgba(0,0,0,.55);max-width:980px;width:96vw;max-height:88vh;display:flex;flex-direction:column;overflow:hidden}
    .overlayHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .overlayTitle{font-weight:950;font-size:14px;color:#cbd5e1}
    .overlayClose{appearance:none;border:0;background:#1a1f2e;color:#e5e7eb;font-weight:950;border-radius:10px;padding:6px 10px;cursor:pointer}
    .overlayBody{padding:12px;overflow:auto}
    .overlayGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .pickCard{background:linear-gradient(180deg,#171b28,#0f1320);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.3)}
    .pickCard:active{transform:scale(.98)}
    .pickAvatar{width:88px;height:88px;border-radius:50%;background:#2a3250;color:#dfe6ff;display:flex;align-items:center;justify-content:center;font-weight:950;box-shadow:0 0 0 1px rgba(255,255,255,.08);background-size:cover;background-position:center;position:relative}
    .pickNumBadge{position:absolute;bottom:-6px;right:-6px;width:34px;height:34px;border-radius:50%;background:#1a1f2e;border:1px solid rgba(255,255,255,.16);display:flex;align-items:center;justify-content:center;font-weight:950;font-size:12px;color:#e8ecf1;box-shadow:0 10px 18px rgba(0,0,0,.35);}
    .pickName{font-weight:950;font-size:13px;text-align:center}
    .pickMeta{font-size:12px;color:#9aa2b1;font-weight:900}
    .noCandidates{color:#9aa2b1;text-align:center;padding:20px;font-weight:900}

    /* Date/Time pickers */
    .pickerBackdrop{position:fixed;inset:0;z-index:2000;background:rgba(8,10,16,.65);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;padding:14px}
    .pickerPanel{background:#0e1320;border:1px solid rgba(255,255,255,.14);border-radius:18px;box-shadow:0 22px 80px rgba(0,0,0,.60);width:min(520px, 96vw);overflow:hidden}
    .pickerHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .pickerHead .t{font-weight:950;font-size:14px;color:#cbd5e1}
    .pickerHead button{background:#1a1f2e;border:1px solid rgba(255,255,255,.10);padding:10px 12px;border-radius:12px;font-weight:950}
    .pickerBody{padding:14px}
    .calTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .calTop .navBtn{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center}
    .calTop .monthLabel{font-weight:950;font-size:16px}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{color:rgba(154,162,177,.9);font-weight:950;font-size:12px;text-align:center;padding:6px 0}
    .dow.weekend{color:rgba(154,162,177,.65)}
    .dayBtn{background:#0f1320;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px 0;font-weight:950;cursor:pointer}
    .dayBtn.weekend{background:rgba(255,255,255,.03)}
    .dayBtn:hover{border-color:rgba(79,140,255,.45)}
    .dayBtn.muted{opacity:.35}
    .dayBtn.selected{border-color:rgba(79,140,255,.85);background:rgba(79,140,255,.18);box-shadow:0 0 0 4px rgba(79,140,255,.10)}
    .pickerFoot{display:flex;gap:10px;justify-content:flex-end;align-items:center;padding:12px 14px;border-top:1px solid rgba(255,255,255,.08)}
    .pickerFoot .hint{margin-right:auto;color:var(--muted);font-size:12px;font-weight:900}
    .timeGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .timeCol{background:#0f1320;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;max-height:320px;overflow:auto}
    .timeOpt{padding:12px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);margin-bottom:8px;font-weight:950;text-align:center;cursor:pointer;background:rgba(255,255,255,.02)}
    .timeOpt:hover{border-color:rgba(79,140,255,.45)}
    .timeOpt.selected{border-color:rgba(79,140,255,.85);background:rgba(79,140,255,.18);box-shadow:0 0 0 4px rgba(79,140,255,.10)}
  
    #teamBanner img{
      max-width:220px;
      max-height:220px;
      border-radius:0;
      box-shadow:none;
      background:none;
    }
  
.pseNum{font-size:18px;font-weight:800}
.pseDesc{font-size:11px;font-weight:600;opacity:.75;line-height:1.15;margin-top:3px;text-align:center}














.pseBtn{
  background:transparent;
  border:2px solid rgba(255,255,255,0.25);
}

.pseBtn[data-pse="0"]{border-color:#b0b0b0;color:#b0b0b0;}
.pseBtn[data-pse="1"]{border-color:#2e7d32;color:#2e7d32;}
.pseBtn[data-pse="2"]{border-color:#388e3c;color:#388e3c;}
.pseBtn[data-pse="3"]{border-color:#689f38;color:#689f38;}
.pseBtn[data-pse="4"]{border-color:#afb42b;color:#afb42b;}
.pseBtn[data-pse="5"]{border-color:#fbc02d;color:#fbc02d;}
.pseBtn[data-pse="6"]{border-color:#f9a825;color:#f9a825;}
.pseBtn[data-pse="7"]{border-color:#f57c00;color:#f57c00;}
.pseBtn[data-pse="8"]{border-color:#ef5350;color:#ef5350;}
.pseBtn[data-pse="9"]{border-color:#e53935;color:#e53935;}
.pseBtn[data-pse="10"]{border-color:#d32f2f;color:#d32f2f;}

</style>


</head>
<body>
  <header>
    <div class="title">
      <span>üìä PSE P√≥s‚ÄëTreino</span>
      <small id="subLabel">Perfis</small>
    </div>
    <div class="tabs">
      <div class="tab active" id="tabPerfis">Perfis</div>
      <div class="tab" id="tabInicio">In√≠cio</div>
      <div class="tab" id="tabPSE" style="display:none">PSE</div>
    </div>
    <div class="controls">
      <button id="exportBtn" class="accent">Exportar CSV</button>
      <button id="resetBtn" class="danger">Reset</button>
    </div>
  </header>

  <main id="pagePerfis" class="layout full">
    <section>
      <div class="rowTitle">Perfis</div>
      <div class="grid profiles" id="profilesGrid"></div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="addFieldBtn" class="ghost">+ Jogador Campo</button>
        <button id="addGKBtn" class="ghost">+ Guarda‚Äëredes</button>
      </div>
      <div class="note" style="margin-top:8px">Em cada perfil, preencha <b>N¬∫</b> e <b>Nome</b>. Para recolher PSE: v√° a <b>In√≠cio</b>.</div>
    </section>
  </main>

  <main id="pageInicio" class="layout full" style="display:none">
    <section>
      <div class="rowTitle">Sess√£o</div>
      <div style="position:relative;display:flex;justify-content:center;align-items:center;gap:10px;margin-top:6px">
  <div style="display:flex;gap:10px">
    <button id="sessionDateBtn" class="dtBtn" style="width:160px"><span id="sessionDateLabel">Selecionar data</span></button>
    <button id="sessionTimeBtn" class="dtBtn" style="width:160px"><span id="sessionTimeLabel">Selecionar hora</span></button>
  </div>
  <button id="resetSessionDT" class="danger" style="position:absolute;right:0;padding:8px 10px;border-radius:10px;font-size:13px;font-weight:900">Reset</button>
</div>
        
      </div>

              </div>

      <div class="rowTitle" style="margin-top:12px">Selecionar contexto</div>
      <div class="choiceGrid">
        <div class="choiceCard" id="chooseGym"><div class="choiceTitle">GIN√ÅSIO</div></div>
        <div class="choiceCard" id="chooseCourt"><div class="choiceTitle">QUADRA</div></div>
      </div>

      <div id="teamBanner" style="display:none;justify-content:center;margin-top:16px"></div>

      <div class="note" style="margin-top:10px">Depois de selecionar <b>Data</b> e <b>Hora</b>, escolha <b>GIN√ÅSIO</b> ou <b>QUADRA</b>.</div>
    </section>
  </main>

  <main id="pagePSE" class="layout full" style="display:none">
    <section class="pseWrap">
      <div class="pseTop">
        <div class="pseWho">
          <div class="avatar lg" id="pseAvatar">?</div>
          <div class="whoTxt">
            <div class="whoName" id="pseName">Atleta</div>
            <div class="whoMeta" id="pseMeta">Contexto</div>
          </div>
        </div>
        <button id="cancelPSEBtn" class="ghost">Cancelar</button>
      </div>

      <div class="pseButtons" id="pseButtons"></div>

      <div class="confirmRow">
        <div class="confirmHint" id="confirmHint"></div>
        <button id="confirmBtn" class="accent" style="display:none">Confirmar</button>
      </div>

      <div class="note" style="margin-top:10px">De 0 a 10 qual foi a tua perce√ß√£o de esfor√ßo durante a sess√£o de treino/jogo?</div>
    </section>
  </main>

  <script>
    const LS_KEY = "pse-collector-v8";
    const roles = { GK:"GK", F:"F" };
    const roleLabel = r => r===roles.GK ? "Guarda‚Äëredes" : "Jogador Campo";
    function uid(){ return Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36); }
    function nowISO(){ return new Date().toISOString(); }

    let state = { profiles: [], entries: [] };

    function defaultProfiles(){
      return [
        { id: 'TEAM', name: 'Equipa', role: 'TEAM', photo: null },
        newProfile("Atleta 1", roles.F, 1),
        newProfile("Atleta 2", roles.F, 2),
        newProfile("Guarda‚Äëredes", roles.GK, 3),
        newProfile("Atleta 4", roles.F, 4),
        newProfile("Atleta 5", roles.F, 5),
      ];
    }
    function newProfile(name, role, num){
      return { id: uid(), num: (num ?? ""), name: name || "", role: role || roles.F, photo: null };
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){ try{ state = JSON.parse(raw) || state; }catch(e){} }
      if(!Array.isArray(state.profiles) || state.profiles.length===0) state.profiles = defaultProfiles();
      // Garantir que o cart√£o "Equipa" existe sempre em 1¬∫ lugar
      if(!state.profiles.some(p => p && p.role === "TEAM")){
        state.profiles.unshift({ id: "TEAM", name: "Equipa", role: "TEAM", photo: null });
      }else{
        // Se existir, garantir que est√° em 1¬∫
        const i = state.profiles.findIndex(p => p && p.role === "TEAM");
        if(i > 0){
          const t = state.profiles.splice(i,1)[0];
          state.profiles.unshift(t);
        }
      }
      if(!Array.isArray(state.entries)) state.entries = [];
      paintAll();
    }

    /* Pages */
    const pages = {
      Perfis: document.getElementById("pagePerfis"),
      Inicio: document.getElementById("pageInicio"),
      PSE: document.getElementById("pagePSE")
    };
    const subLabel = document.getElementById("subLabel");
    const tabPerfis = document.getElementById("tabPerfis");
    const tabInicio = document.getElementById("tabInicio");
    const tabPSE = document.getElementById("tabPSE");

    function showPage(id){
      Object.keys(pages).forEach(k => pages[k].style.display = (k===id) ? "grid" : "none");
      [tabPerfis, tabInicio, tabPSE].forEach(t => t.classList.remove("active"));
      if(id==="Perfis"){ tabPerfis.classList.add("active"); subLabel.textContent="Perfis"; }
      if(id==="Inicio"){ tabInicio.classList.add("active"); subLabel.textContent="In√≠cio"; }
      if(id==="PSE"){ tabPSE.classList.add("active"); subLabel.textContent="PSE"; }
      tabPSE.style.display = (id==="PSE") ? "block" : "none";
    }
    tabPerfis.onclick = () => { currentContext=""; showPage("Perfis"); };
    tabInicio.onclick = () => { currentContext=""; showPage("Inicio"); };

    /* Profiles */
    const profilesGrid = document.getElementById("profilesGrid");

    function setAvatar(el, p){
      if(p && p.photo){
        el.style.backgroundImage = `url('${p.photo}')`;
        el.textContent = "";
      }else{
        el.style.backgroundImage = "none";
        const letter = (p && p.name ? p.name.trim()[0] : "?") || "?";
        el.textContent = letter.toUpperCase();
      }
    }
    async function fileToResizedDataURL(file, maxSize=640, mime="image/jpeg", quality=.92){
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onerror = rej;
        fr.onload = () => {
          const img = new Image();
          img.onload = () => {
            const c = document.createElement("canvas");
            let w = img.width, h = img.height;
            const s = Math.min(1, maxSize / Math.max(w, h));
            w = Math.round(w*s); h = Math.round(h*s);
            c.width = w; c.height = h;
            const ctx = c.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            try{ res(c.toDataURL(mime, quality)); }catch(e){ rej(e); }
          };
          img.onerror = rej;
          img.src = fr.result;
        };
        fr.readAsDataURL(file);
      });
    }
    function pickPhoto(cb){
      const input = document.createElement("input");
      input.type="file";
      input.accept="image/png,image/jpeg";
      input.onchange = async () => {
        const f = input.files && input.files[0];
        if(!f) return;
        try{
          const isPng = f.type === "image/png";
          const data = await fileToResizedDataURL(f, 640, isPng ? "image/png" : "image/jpeg", .95);
          cb(data); save();
        }catch(e){ alert("Falha ao carregar a imagem."); }
      };
      input.click();
    }

    
    function profileCard(p){
      const card = document.createElement("div");
      const isTeam = p.role === "TEAM";
      card.className = "card " + (isTeam ? "field" : (p.role===roles.GK ? "gk" : "field"));


      const top = document.createElement("div");
      top.className = "avatarRow";

      const av = document.createElement("div");
      av.className = "avatar lg";
      setAvatar(av, p);
      top.appendChild(av);

      const nameLine = document.createElement("div");
      nameLine.className = "nameLine";
      nameLine.style.flex = 1;

      const num = document.createElement("input");
      num.className = "numInput";
      num.type = "text";
      num.inputMode = "numeric";
      num.placeholder = "N¬∫";
      num.value = (p.num ?? "");
      num.oninput = () => { num.value = num.value.replace(/[^\d]/g, "").slice(0,3); };
      num.onchange = () => { p.num = (num.value || "").trim(); save(); paintAll(); };

      const name = document.createElement("input");
      name.className = "nameInput";
      name.type = "text";
      name.placeholder = p.role===roles.GK ? "Guarda‚Äëredes" : "Atleta";
      name.value = p.name || "";
      name.onchange = () => { p.name = (name.value || "").trim(); save(); paintAll(); };

      if(!isTeam){ nameLine.appendChild(num); }
      nameLine.appendChild(name);
      top.appendChild(nameLine);
      card.appendChild(top);

      const actions = document.createElement("div");
      actions.className = "avatarRow";
      actions.style.flexWrap = "wrap";

      const sel = document.createElement("select");
      sel.className = "roleSel";
      sel.innerHTML = `<option value="F"${p.role===roles.F?" selected":""}>Campo</option><option value="GK"${p.role===roles.GK?" selected":""}>GR</option>`;
      sel.onchange = () => { p.role = sel.value; save(); paintAll(); };
      if(!isTeam){ actions.appendChild(sel); }

      const btnFoto = document.createElement("button");
      btnFoto.className = "ghost";
      btnFoto.textContent = "Foto";
      btnFoto.onclick = () => pickPhoto(d => { p.photo = d; paintAll(); });

      const btnDelFoto = document.createElement("button");
      btnDelFoto.className = "ghost";
      btnDelFoto.textContent = "Remover foto";
      btnDelFoto.onclick = () => { p.photo = null; paintAll(); save(); };

      const del = document.createElement("button");
      del.className = "ghost";
      del.textContent = "Remover perfil";
      del.onclick = () => {
        if(!confirm("Remover este perfil?")) return;
        state.profiles = state.profiles.filter(x => x.id !== p.id);
        paintAll(); save();
      };

      actions.appendChild(btnFoto);
      actions.appendChild(btnDelFoto);
      if(!isTeam){ actions.appendChild(del); }

      card.appendChild(actions);
      return card;
    }

    function paintProfiles(){
      profilesGrid.innerHTML = "";
      state.profiles.forEach(p => profilesGrid.appendChild(profileCard(p)));
    }

    document.getElementById("addFieldBtn").onclick = () => { state.profiles.push(newProfile("Atleta", roles.F, "")); paintAll(); save(); };
    document.getElementById("addGKBtn").onclick = () => { state.profiles.push(newProfile("Guarda‚Äëredes", roles.GK, "")); paintAll(); save(); };

    /* Session Date/Time (persist) */
    let selectedDate = "";
    let selectedTime = "";
    const DT_KEY_DATE = LS_KEY + ":sessionDate";
    const DT_KEY_TIME = LS_KEY + ":sessionTime";

    function fmtDatePT(yyyy_mm_dd){
      if(!yyyy_mm_dd) return "";
      const [y,m,d] = yyyy_mm_dd.split("-").map(x=>parseInt(x,10));
      if(!y||!m||!d) return "";
      return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
    }
    function refreshSessionLabels(){
      const dl = document.getElementById("sessionDateLabel");
      const tl = document.getElementById("sessionTimeLabel");
      if(dl) dl.textContent = selectedDate ? fmtDatePT(selectedDate) : "Selecionar data";
      if(tl) tl.textContent = selectedTime ? selectedTime : "Selecionar hora";
    }
    function loadSessionDT(){
      try{
        selectedDate = localStorage.getItem(DT_KEY_DATE) || "";
        selectedTime = localStorage.getItem(DT_KEY_TIME) || "";
      }catch(e){ selectedDate=""; selectedTime=""; }
      refreshSessionLabels();
    }
    function bindSessionDT(){
      document.getElementById("sessionDateBtn").addEventListener("click", openDatePicker);
      document.getElementById("sessionTimeBtn").addEventListener("click", openTimePicker);
      document.getElementById("resetSessionDT").addEventListener("click", () => {
        selectedDate=""; selectedTime="";
        try{ localStorage.removeItem(DT_KEY_DATE); localStorage.removeItem(DT_KEY_TIME);}catch(e){}
        refreshSessionLabels();
      });
    }

    function openDatePicker(){
      const today = new Date();
      let viewYear = selectedDate ? parseInt(selectedDate.slice(0,4),10) : today.getFullYear();
      let viewMonth = selectedDate ? (parseInt(selectedDate.slice(5,7),10)-1) : today.getMonth();
      if(!isFinite(viewYear) || !isFinite(viewMonth)){ viewYear=today.getFullYear(); viewMonth=today.getMonth(); }

      const backdrop = document.createElement("div");
      backdrop.className = "pickerBackdrop";
      backdrop.innerHTML = `
        <div class="pickerPanel">
          <div class="pickerHead">
            <div class="t">Selecionar data</div>
            <button id="dpClose">Fechar</button>
          </div>
          <div class="pickerBody">
            <div class="calTop">
              <button class="navBtn" id="dpPrev">‚Äπ</button>
              <div class="monthLabel" id="dpMonthLabel"></div>
              <button class="navBtn" id="dpNext">‚Ä∫</button>
            </div>
            <div class="calGrid" id="dpDOW"></div>
            <div class="calGrid" id="dpGrid"></div>
          </div>
          <div class="pickerFoot">
            <button id="dpToday">Hoje</button>
            <div class="hint">Clique num dia para selecionar.</div>
            <button class="accent" id="dpConfirm">Confirmar</button>
          </div>
        </div>
      `;
      document.body.appendChild(backdrop);

      const monthNames = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      const dowNames = ["S","T","Q","Q","S","S","D"];
      const dow = backdrop.querySelector("#dpDOW");
      dow.innerHTML = dowNames.map((x,idx)=>`<div class="dow ${idx>=5?"weekend":""}">${x}</div>`).join("");

      let tempSelected = selectedDate || "";

      function build(){
        backdrop.querySelector("#dpMonthLabel").textContent = `${monthNames[viewMonth]} ${viewYear}`;
        const grid = backdrop.querySelector("#dpGrid");
        grid.innerHTML = "";

        const first = new Date(viewYear, viewMonth, 1);
        const firstDay = (first.getDay() + 6) % 7; // Mon=0
        const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
        const prevDays = new Date(viewYear, viewMonth, 0).getDate();

        for(let i=0;i<42;i++){
          const cell = document.createElement("button");
          cell.type="button";
          cell.className = "dayBtn" + ((i%7)>=5 ? " weekend" : "");

          const dayNum = i - firstDay + 1;
          let cellY=viewYear, cellM=viewMonth, cellD=dayNum;

          if(dayNum <= 0){
            cell.classList.add("muted");
            const pm = new Date(viewYear, viewMonth, 0);
            cellY = pm.getFullYear();
            cellM = pm.getMonth();
            cellD = prevDays + dayNum;
            cell.textContent = String(cellD);
          }else if(dayNum > daysInMonth){
            cell.classList.add("muted");
            const nm = new Date(viewYear, viewMonth+1, 1);
            cellY = nm.getFullYear();
            cellM = nm.getMonth();
            cellD = dayNum - daysInMonth;
            cell.textContent = String(cellD);
          }else{
            cell.textContent = String(dayNum);
          }

          const val = `${cellY}-${String(cellM+1).padStart(2,"0")}-${String(cellD).padStart(2,"0")}`;
          if(val === tempSelected) cell.classList.add("selected");

          cell.addEventListener("click", () => {
            tempSelected = val;
            viewYear = cellY; viewMonth = cellM;
            build();
          });

          grid.appendChild(cell);
        }
      }

      function close(){
        document.removeEventListener("keydown", onKey);
        backdrop.remove();
      }
      function onKey(e){ if(e.key==="Escape") close(); }
      backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) close(); });
      backdrop.querySelector("#dpClose").addEventListener("click", close);

      backdrop.querySelector("#dpPrev").addEventListener("click", () => {
        const d = new Date(viewYear, viewMonth-1, 1);
        viewYear=d.getFullYear(); viewMonth=d.getMonth(); build();
      });
      backdrop.querySelector("#dpNext").addEventListener("click", () => {
        const d = new Date(viewYear, viewMonth+1, 1);
        viewYear=d.getFullYear(); viewMonth=d.getMonth(); build();
      });

      backdrop.querySelector("#dpToday").addEventListener("click", () => {
        const t = new Date();
        const y = t.getFullYear();
        const m = String(t.getMonth()+1).padStart(2,"0");
        const d = String(t.getDate()).padStart(2,"0");
        selectedDate = `${y}-${m}-${d}`;
        try{ localStorage.setItem(DT_KEY_DATE, selectedDate);}catch(e){}
        refreshSessionLabels();
        close();
      });

      backdrop.querySelector("#dpConfirm").addEventListener("click", () => {
        if(!tempSelected){ alert("Selecione um dia."); return; }
        selectedDate = tempSelected;
        try{ localStorage.setItem(DT_KEY_DATE, selectedDate);}catch(e){}
        refreshSessionLabels();
        close();
      });

      document.addEventListener("keydown", onKey);
      build();
    }

    function openTimePicker(){
      const backdrop = document.createElement("div");
      backdrop.className = "pickerBackdrop";

      let hSel=0, mSel=0;
      if(selectedTime && /^\d\d:\d\d/.test(selectedTime)){
        hSel = parseInt(selectedTime.slice(0,2),10) || 0;
        mSel = parseInt(selectedTime.slice(3,5),10) || 0;
        mSel = Math.round(mSel/15)*15; if(mSel===60) mSel=55;
      }else{
        const now = new Date();
        hSel = now.getHours();
        mSel = Math.round(now.getMinutes()/15)*15; if(mSel===60) mSel=55;
      }

      backdrop.innerHTML = `
        <div class="pickerPanel">
          <div class="pickerHead">
            <div class="t">Selecionar hora</div>
            <button id="tpClose">Fechar</button>
          </div>
          <div class="pickerBody">
            <div class="timeGrid">
              <div>
                <div class="rowTitle" style="margin:0 0 8px 2px">Horas</div>
                <div class="timeCol" id="tpHours"></div>
              </div>
              <div>
                <div class="rowTitle" style="margin:0 0 8px 2px">Minutos (15 em 15)</div>
                <div class="timeCol" id="tpMins"></div>
              </div>
            </div>
          </div>
          <div class="pickerFoot">
            <div class="hint" id="tpHint"></div>
            <button class="accent" id="tpConfirm">Confirmar</button>
          </div>
        </div>
      `;
      document.body.appendChild(backdrop);

      const hoursEl = backdrop.querySelector("#tpHours");
      const minsEl  = backdrop.querySelector("#tpMins");
      const hintEl  = backdrop.querySelector("#tpHint");
      const pad2 = n => String(n).padStart(2,"0");

      function refreshHint(){ hintEl.textContent = `Selecionado: ${pad2(hSel)}:${pad2(mSel)}`; }

      function buildHours(){
        hoursEl.innerHTML="";
        for(let h=0;h<=23;h++){
          const b=document.createElement("div");
          b.className="timeOpt"+(h===hSel?" selected":"");
          b.textContent=pad2(h);
          b.addEventListener("click", ()=>{ hSel=h; buildHours(); refreshHint(); });
          hoursEl.appendChild(b);
        }
      }
      function buildMins(){
        minsEl.innerHTML="";
        for(let m=0;m<=45;m+=15){
          const b=document.createElement("div");
          b.className="timeOpt"+(m===mSel?" selected":"");
          b.textContent=pad2(m);
          b.addEventListener("click", ()=>{ mSel=m; buildMins(); refreshHint(); });
          minsEl.appendChild(b);
        }
      }

      function close(){ document.removeEventListener("keydown", onKey); backdrop.remove(); }
      function onKey(e){ if(e.key==="Escape") close(); }
      backdrop.addEventListener("click",(e)=>{ if(e.target===backdrop) close(); });
      backdrop.querySelector("#tpClose").addEventListener("click", close);

      backdrop.querySelector("#tpConfirm").addEventListener("click", ()=> {
        selectedTime = `${pad2(hSel)}:${pad2(mSel)}`;
        try{ localStorage.setItem(DT_KEY_TIME, selectedTime);}catch(e){}
        refreshSessionLabels();
        close();
      });

      document.addEventListener("keydown", onKey);
      buildHours(); buildMins(); refreshHint();
      setTimeout(()=> {
        const hs=hoursEl.querySelector(".selected"); const ms=minsEl.querySelector(".selected");
        if(hs) hs.scrollIntoView({block:"center"});
        if(ms) ms.scrollIntoView({block:"center"});
      },0);
    }

    /* Flow: Inicio -> Picker -> PSE -> Confirm -> back */
    let currentContext = "";
    let selectedProfile = null;
    let selectedPSE = null;

    document.getElementById("chooseGym").onclick = () => {
      if(!selectedDate || !selectedTime){ alert("Selecione primeiro a Data e a Hora."); return; }
      currentContext = "GIN√ÅSIO"; openPicker();
    };
    document.getElementById("chooseCourt").onclick = () => {
      if(!selectedDate || !selectedTime){ alert("Selecione primeiro a Data e a Hora."); return; }
      currentContext = "QUADRA"; openPicker();
    };

    function escapeHtml(str){
      return String(str).replace(/[&<>\"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }

    function openPicker(){
      const candidates = state.profiles.filter(p => p.role !== "TEAM");
      const ov = document.createElement('div');
      ov.className = 'overlayPicker';
      ov.innerHTML = `
        <div class="overlayPanel">
          <div class="overlayHeader">
            <div class="overlayTitle">Selecionar atleta ‚Äî ${escapeHtml(currentContext)}</div>
            <button class="overlayClose" id="ovCloseBtn">Fechar</button>
          </div>
          <div class="overlayBody">
            <div class="overlayGrid" id="ovGrid"></div>
          </div>
        </div>`;
      document.body.appendChild(ov);

      const grid = ov.querySelector('#ovGrid');
      if(candidates.length===0){
        const msg = document.createElement('div');
        msg.className = 'noCandidates';
        msg.textContent = 'Sem atletas. Crie perfis primeiro.';
        grid.replaceWith(msg);
      }else{
        candidates.forEach(p => {
          const card = document.createElement('div');
          card.className = 'pickCard';

          const av = document.createElement('div');
          av.className = 'pickAvatar';
          if(p.photo){ av.style.backgroundImage = `url('${p.photo}')`; av.textContent = ""; }
          else { av.style.backgroundImage = "none"; av.textContent = ((p.name||"?")[0]||"?").toUpperCase(); }
const name = document.createElement('div');
          name.className = 'pickName';
          name.textContent = p.name || "Atleta";

          const meta = document.createElement('div');
          meta.className = 'pickMeta';
          meta.textContent = (p.num && String(p.num).trim() !== "") ? String(p.num).trim() : "‚Äî";

          card.appendChild(av);
          card.appendChild(name);
          card.appendChild(meta);

          card.onclick = () => { selectedProfile = p; close(); openPSE(p); };
          grid.appendChild(card);
        });
      }

      function close(){
        if(ov && ov.parentNode) ov.parentNode.removeChild(ov);
        document.removeEventListener('keydown', onKey);
      }
      function onKey(e){ if(e.key==='Escape') close(); }
      ov.querySelector('#ovCloseBtn').onclick = close;
      ov.addEventListener('click', (e)=>{ if(e.target===ov) close(); });
      document.addEventListener('keydown', onKey);
    }

    /* PSE */
    const pseAvatar = document.getElementById("pseAvatar");
    const pseName = document.getElementById("pseName");
    const pseMeta = document.getElementById("pseMeta");
    const pseButtons = document.getElementById("pseButtons");
    const cancelPSEBtn = document.getElementById("cancelPSEBtn");
    const confirmBtn = document.getElementById("confirmBtn");
    const confirmHint = document.getElementById("confirmHint");

    cancelPSEBtn.onclick = () => {
      selectedProfile=null; selectedPSE=null; currentContext="";
      confirmBtn.style.display="none"; confirmHint.textContent="";
      showPage("Inicio");
    };

    function openPSE(p){
      setAvatar(pseAvatar, p);
      pseName.textContent = `${p.name || "Atleta"}`;
      pseMeta.textContent = `${currentContext} ‚Ä¢ ${fmtDatePT(selectedDate)} ${selectedTime}`;
      selectedPSE=null;
      confirmBtn.style.display="none";
      confirmHint.textContent="";

      pseButtons.innerHTML="";
      for(let i=0;i<=10;i++){
        const b=document.createElement("div");
        b.className="pseBtn";
        b.setAttribute("data-pse", i);
        b.textContent=String(i);
        b.onclick=()=>{
          if(selectedPSE===i){
            selectedPSE=null;
            b.classList.remove("selected");
            confirmBtn.style.display="none";
            confirmHint.textContent="";
            return;
          }
          selectedPSE=i;
          Array.from(pseButtons.querySelectorAll(".pseBtn")).forEach(x=>x.classList.remove("selected"));
          b.classList.add("selected");
          confirmBtn.style.display="inline-block";
          confirmHint.textContent=`Selecionado: ${i}. Clique em Confirmar.`;
        };
        pseButtons.appendChild(b);
      }
      showPage("PSE");
  const team = state.profiles.find(p=>p.role==="TEAM");
  const teamBannerPSE = document.getElementById("teamBannerPSE");
  if(team && team.photo && teamBannerPSE){
    teamBannerPSE.style.display="flex";
    teamBannerPSE.innerHTML = `<img src="${team.photo}" alt="Equipa">`;
  }else if(teamBannerPSE){ teamBannerPSE.style.display="none"; }
}

    confirmBtn.onclick = () => {
      if(!selectedProfile || !selectedPSE || !currentContext) return;
      if(!selectedDate || !selectedTime){ alert("Selecione a Data e a Hora antes de confirmar a PSE."); return; }

      state.entries.push({
        ts: nowISO(),
        sessionDate: selectedDate,
        sessionTime: selectedTime,
        context: currentContext,
        athleteId: selectedProfile.id,
        athleteNum: (selectedProfile.num ?? ""),
        athleteName: selectedProfile.name ?? "",
        role: selectedProfile.role,
        pse: selectedPSE
      });
      save();

      selectedProfile=null; selectedPSE=null; currentContext="";
      confirmBtn.style.display="none"; confirmHint.textContent="";
      showPage("Inicio");
    };

    /* Export CSV */
    document.getElementById("exportBtn").onclick = () => {
      const rows = [["DataHora_ISO","Data","Hora","Contexto","Numero","Atleta","Posicao","PSE"]];
      for(const e of state.entries){
        rows.push([e.ts, (e.sessionDate||""), (e.sessionTime||""), e.context, e.athleteNum, e.athleteName, e.role, e.pse]);
      }
      const csv = rows.map(r => r.map(x => `"${String(x??"").replaceAll('"','""')}"`).join(",")).join("\n");
      const fname = `PSE - ${new Date().toLocaleDateString('pt-PT')}.csv`;
      const a = document.createElement("a");
      a.setAttribute("href","data:text/csv;charset=utf-8," + encodeURIComponent(csv));
      a.setAttribute("download", fname);
      document.body.appendChild(a); a.click(); a.remove();
    };

    /* Reset ALL */
    document.getElementById("resetBtn").onclick = () => {
      if(!confirm("Isto vai repor perfis (exemplos) e apagar todos os registos de PSE guardados neste dispositivo. Confirmar?")) return;
      state = { profiles: defaultProfiles(), entries: [] };
      save();
      paintAll();
      showPage("Perfis");
    };

    
    function paintAll(){
      paintProfiles();
      const team = state.profiles.find(p=>p.role==="TEAM");
      const banner = document.getElementById("teamBanner");
      if(banner){
        if(team && team.photo){
          banner.style.display="flex";
          banner.innerHTML = `<img src="${team.photo}" alt="Equipa">`;
        }else{
          banner.style.display="none";
          banner.innerHTML = "";
        }
      }
    }


    // Boot
    load();
    loadSessionDT();
    bindSessionDT();
    showPage("Perfis");
  </script>
</body>
</html>
